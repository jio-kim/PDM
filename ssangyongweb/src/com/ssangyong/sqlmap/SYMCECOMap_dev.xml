<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">  
  
<mapper namespace="com.ssangyong.mapper.SYMCECOMapper">
    <!-- ECO NO를 생성 -->
	<select id="getNextECOSerial" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT #{prefix}||LTRIM(NVL(TO_CHAR(TO_NUMBER(MAX(SUBSTR(I.PITEM_ID,LENGTH(I.PITEM_ID)-2)))+1,'009'),'001')) nextID
		FROM INFODBA.PITEM I
		    ,INFODBA.PWORKSPACEOBJECT WO
		WHERE I.PUID = WO.PUID
		   AND WO.POBJECT_TYPE = 'S7_ECO'
		   AND I.PITEM_ID LIKE #{prefix}||'%'
	</select>
	<!-- ECO 결재선 저장 -->
	<insert id="saveApprovalLine" parameterType="ApprovalLineData">
		insert into eco_approval_line 
		     ( 
		       eco_no 
		      ,sort 
		      ,task 
		      ,team_name 
		      ,user_name 
		      ,tc_member_puid 
		       ) 
		values 
		     ( 
		       #{eco_no} 
		      ,#{sort} 
		      ,#{task} 
		      ,#{team_name} 
		      ,#{user_name} 
		      ,#{tc_member_puid} 
		       )
	</insert>
	<!-- ECO 결재선 불러오기 -->
	<select id="getApprovalLine" parameterType="ApprovalLineData" resultType="ApprovalLineData">
		select eco_no 
		      ,sort 
		      ,task 
		      ,team_name 
		      ,user_name 
		      ,tc_member_puid
		from eco_approval_line
		where eco_no = #{eco_no}
		ORDER BY sort
	</select>
	<!-- ECO 결재선 삭제 -->
	<delete id="removeApprovalLine" parameterType="ApprovalLineData">
		delete from eco_approval_line
		where eco_no = #{eco_no}
	</delete>
	<!-- 사용자 결재선[ECO/ECI] 저장하기 -->
	<insert id="saveUserApprovalLine" parameterType="ApprovalLineData">
		insert into eco_approval_line 
		     ( 
    		   eco_no
		      ,saved_name 
		      ,saved_user
		      ,sort 
		      ,task 
		      ,team_name 
		      ,user_name 
		      ,tc_member_puid 
		       ) 
		values 
		     (
    		   #{eco_no}
		      ,#{saved_name}
		      ,#{saved_user}
		      ,#{sort} 
		      ,#{task} 
		      ,#{team_name} 
		      ,#{user_name} 
		      ,#{tc_member_puid} 
		       )
	</insert>
	<!-- 저장된 사용자 결재선 이름 모두 가져오기 -->
	<select id="loadSavedUserApprovalLine" parameterType="ApprovalLineData" resultType="ApprovalLineData">
		select distinct saved_name
		from eco_approval_line
		where saved_user = #{saved_user}
		AND eco_no = #{eco_no}
	</select>
	
	<delete id="deleteApprovalLine" parameterType="ApprovalLineData">
		DELETE FROM ECO_APPROVAL_LINE
		WHERE SAVED_NAME = #{saved_name} 
		   AND SAVED_USER = #{saved_user} 
		   AND ECO_NO = #{eco_no}
	</delete>
	<!-- 저장된 사용자 결재선 가져오기 -->
	<select id="loadApprovalLine" parameterType="ApprovalLineData" resultType="ApprovalLineData">
		SELECT TASK 
		     ,G.PNAME TEAM_NAME 
		     ,U.PUSER_NAME USER_NAME 
		     ,TC_MEMBER_PUID 
		FROM ECO_APPROVAL_LINE AL 
		     ,INFODBA.PPOM_MEMBER M 
		     ,INFODBA.PPOM_USER U 
		     ,INFODBA.PPOM_GROUP G 
		WHERE AL.TC_MEMBER_PUID = M.PUID 
		   AND M.RUSERU = U.PUID 
		   AND M.RGROUPU = G.PUID 
		   AND SAVED_NAME = #{saved_name} 
		   AND SAVED_USER = #{saved_user} 
		   AND ECO_NO = #{eco_no}
	    ORDER BY AL.SORT
	</select>
	<!-- ECI 테이블 미생성으로 인한 쿼리 미완성 임. -->
	<select id="searchEOStatus" parameterType="SYMCECOStatusData" resultType="SYMCECOStatusData">
		WITH ECI AS (
		    SELECT IR.RPRIMARY_OBJECTU PUID, AI.PITEM_ID, AV.PS7_ECI_MATURITY
		    FROM INFODBA.PITEM AI
			    ,INFODBA.PITEMREVISION AR
			    ,INFODBA.PS7_ECIREVISION_0 AV
			    ,INFODBA.PWORKSPACEOBJECT AW
			    ,INFODBA.PIMANRELATION IR
		    WHERE AI.PUID = AR.RITEMS_TAGU
		    AND AR.PUID = AV.PUID
		    AND AR.PUID = AW.PUID
		    AND AR.PUID = IR.RSECONDARY_OBJECTU
		    AND IR.RPRIMARY_OBJECTU IS NOT NULL
		    AND AW.PACTIVE_SEQ = '1'  ) 
		SELECT  E.PS7_ECR_NO ecrNo
			   ,ECI.PITEM_ID eciNo
		       ,ECI.PS7_ECI_MATURITY eciStatus
			   ,I.PITEM_ID ecoNo
		       ,W.POBJECT_DESC ecoTitle
		       ,DECODE(E.PS7_ECO_MATURITY, NULL, 'In Work', E.PS7_ECO_MATURITY) ecoStatus
		       ,G.PNAME owningTeam
		       ,P.PUSER_NAME owningUser
		       ,TO_CHAR(A.PCREATION_DATE + 9 / 24 ,'YYYY-MM-DD') createDate
		       ,TO_CHAR(TA.PCREATION_DATE + 9 / 24 ,'YYYY-MM-DD') requestDate
		       ,TO_CHAR(W.PDATE_RELEASED + 9 / 24 ,'YYYY-MM-DD') realseDate
		FROM INFODBA.PS7_ECOREVISION_0 E
			,INFODBA.PWORKSPACEOBJECT W
		    ,INFODBA.PPOM_APPLICATION_OBJECT A
		    ,INFODBA.PITEM I
		    ,INFODBA.PITEMREVISION R
		    ,INFODBA.PRELEASE_STATUS_LIST RL
		    ,INFODBA.PRELEASESTATUS RS
		    ,INFODBA.PPOM_GROUP G
		    ,INFODBA.PPOM_USER O
		    ,INFODBA.PUSER U
		    ,INFODBA.PPERSON P
		    ,INFODBA.PATTACHMENTS T
		    ,INFODBA.PPOM_APPLICATION_OBJECT TA
		    ,ECI
		WHERE E.PUID = W.PUID
		AND W.PUID = A.PUID
		AND E.PUID = R.PUID
		AND R.RITEMS_TAGU = I.PUID
		AND W.PACTIVE_SEQ = 1
		AND R.PUID = RL.PUID(+)
		AND RL.PVALU_0 = RS.PUID(+)
		AND A.ROWNING_GROUPU = G.PUID
		AND A.ROWNING_USERU = O.PUID
		AND O.PUID = U.PUID
		AND U.RPERSONU = P.PUID
		AND W.PUID = T.PVALU_0(+)
		AND T.PUID = TA.PUID(+)
		<if test="ecoStatus = 'Completed' or ecoStatus == null">
			AND DECODE(W.PDATE_RELEASED, NULL, '2013-05-04', TO_CHAR(W.PDATE_RELEASED + 9 / 24 ,'YYYY-MM-DD')) <![CDATA[>=]]> #{releaseDateFrom}
			AND DECODE(W.PDATE_RELEASED, NULL, '2013-05-04', TO_CHAR(W.PDATE_RELEASED + 9 / 24 ,'YYYY-MM-DD')) <![CDATA[<=]]> #{releaseDateTo}
		</if>
		AND R.PUID = ECI.PUID(+)
		<if test="ecrNo != null">
    		AND UPPER(E.PS7_ECR_NO) LIKE #{ecrNo}
  		</if>
  		<if test="eciNo != null">
    		AND UPPER(ECI.PITEM_ID) LIKE #{eciNo}
  		</if>
  		<if test="eciStatus != null">
    		AND ECI.PS7_ECI_MATURITY = #{eciStatus}
  		</if>
  		<if test="ecoNo != null">
    		AND UPPER(I.PITEM_ID) LIKE #{ecoNo}
  		</if>
  		<if test="ecoStatus != null">
    		AND DECODE(E.PS7_ECO_MATURITY, NULL, 'In Work', E.PS7_ECO_MATURITY) = #{ecoStatus}
  		</if>
  		<if test="owningTeam != null">
    		AND UPPER(G.PNAME) LIKE #{owningTeam}
  		</if>
  		<if test="owningUser != null">
    		AND UPPER(P.PUSER_NAME) LIKE #{owningUser}
  		</if>
  		ORDER BY I.PITEM_ID
	</select>
	<select id="getVnetTeamInfo" parameterType="com.ssangyong.dto.VnetTeamInfoData" resultType="com.ssangyong.dto.VnetTeamInfoData">
		SELECT DISTINCT a.team team_name
		     ,a.tmcod team_code
		     ,a.ord1
		     ,a.ord2
		     ,a.cls ord3
		FROM cals.sysa01tb@LINK_001_VNET a
		     , cals.sysa02tb@LINK_001_VNET b
		WHERE a.app IN ('0','2')
		   AND length(a.tmcod) >= 8
		   AND b.team = a.team
		   <if test="team_name != null">
	    		AND a.team like '%'||#{team_name}||'%'
	  	   </if>
	  	   <if test="team_code != null">
	    		AND a.tmcod = #{team_code}
	  	   </if>
		ORDER BY a.ord1
		     ,decode(a.ord1,'001',a.ord2,'002',a.ord2,a.team)
		     ,a.cls
    </select>
    <select id="getVnetTeamNames" parameterType="com.ssangyong.dto.VnetTeamInfoData" resultType="com.ssangyong.dto.VnetTeamInfoData">
		SELECT DISTINCT a.team team_name
		     ,a.tmcod team_code
		FROM cals.sysa01tb@LINK_001_VNET a
		     , cals.sysa02tb@LINK_001_VNET b
		WHERE a.app IN ('0','2')
		   AND length(a.tmcod) >= 8
		   AND b.team = a.team
		   AND a.tmcod in 
		  <foreach collection="codeList" item="item" index="index" separator="," open="(" close=")">
    			#{item}
		  </foreach>
    </select>
    <select id="getECIfileInfo" resultType="java.util.HashMap">
		SELECT VNET_REGISTERED_ID||REF_FILE FILENAME
			  ,REF_FILE_PATH FILEPATH
		FROM IF_ECI_INFO_TO_VNET
		WHERE PLM_ITEM_PUID = #{itemPuid}
    </select>
    <insert id="interfaceECI">
	    INSERT INTO IF_ECI_INFO_TO_VNET
			       (
			       VNET_REGISTERED_ID
			      ,PLM_ITEM_PUID
			      ,TITLE
			      ,REPRESENT_VEHICLE
			      ,APPLIED_VEHICLE
			      ,BEFORE_PART_NO
			      ,BEFORE_PART_NAME
			      ,BEFORE_DESC
			      ,AFTER_PART_NO
			      ,AFTER_PART_NAME
			      ,AFTER_DESC
			      ,EXP_INVEST
			      ,CHANGE_CODE
			      ,REVIEW_DEPT
			      ,LAW_CHECK
			      ,SYSTEM_CODE
			      ,US
			      ,SUPPLIER
			      ,AS_COMPATIBLE
			      ,SUPPLY_REQ_YN
			      ,SUBSTITUDE_PART
			      ,ECR_NO
			      ,RELATION_ID
			      ,REASON
			      ,BASE_ON
			      ,EC_MANAGE_CODE
			      ,REASON_OFFER_CODE
			      ,REASON_OFFER_DESC
			      ,REF_FILE
			      ,REF_FILE_PATH
			      ,REF_DEPT
			      ,WORKFLOW
			       )
			SELECT CALS.MAIL_TAB_NO.NEXTVAL@LINK_001_VNET
			     ,I.PUID
			     ,DECODE(ECI.PS7_DOC_DIVISION, 'A', '6SIGMA/MI 관련문서'||ECI.PS7_TITLE,'B', 'SCR 관련문서'||ECI.PS7_TITLE, ECI.PS7_TITLE)
			     ,ECI.PS7_REPRESENT_VEHICLE
			     ,ECI.PS7_APPLIED_VEHICLE
			     ,ECI.PS7_BEFORE_PART_NO
			     ,ECI.PS7_BEFORE_PART_NAME
			     ,ECI.PS7_BEFORE_DESC
			     ,ECI.PS7_AFTER_PART_NO
			     ,ECI.PS7_AFTER_PART_NAME
			     ,ECI.PS7_AFTER_DESC
			     ,ECI.PS7_EXP_INVEST
			     ,ECI.PS7_CHANGE_COST
			     ,ECI.PS7_REVIEW_DEPT
			     ,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ECI.PS7_LAW_CHECK
						,'국내 차량인증','CAR_CERT_01')
			            ,'유럽 차량인증','CAR_CERT_02')
			            ,'중국 차량인증','CAR_CERT_03')
			            ,'기타 차량인증','CAR_CERT_04')
						,'국내 단품인증','PRODUCT_CERT_01')
			            ,'유럽 단품인증','PRODUCT_CERT_02')
			            ,'중국 단품인증','PRODUCT_CERT_03')
			            ,'기타 단품인증','PRODUCT_CERT_04')
			            ,'해당사항없음','NO_CERT')
			     ,ECI.PS7_BUDGET_CODE
			     ,ECI.PS7_US
			     ,ECI.PS7_SUPPLIER
			     ,ECI.PS7_AS_COMPATIBLE
			     ,ECI.PS7_SUPPLY_REQ_YN
			     ,ECI.PS7_REF_FILE
			     ,ECI.PS7_ECR_NO
			     ,ECI.PS7_RELATION_ID
			     ,DECODE(ECI.PS7_CHANGE_REASON,'09','99','11','99','12','99','10','04','03','05','04','06','05','07','07','08','06','11',ECI.PS7_CHANGE_REASON)
			     ,ECI.PS7_BASE_ON
			     ,ECI.PS7_EC_MANAGE_CODE
			     ,ECI.PS7_REASON_OFFER_CODE
			     ,ECI.PS7_REASON_OFFER_DESC
			     ,ECI.PS7_REF_FILE_PATH
			     ,DECODE(ECI.PS7_REF_FILE_PATH,NULL,NULL,'/pis/'||TO_CHAR(SYSDATE,'YYYY'))
			     ,ECI.PS7_REF_DEPT
			     ,U.PUSER_ID||TO_CHAR(TA.PCREATION_DATE+9/24,'YYYYMMDDHH24MISS')||','||( SELECT LISTAGG(H.PUSER_ID||TO_CHAR(C.PDECISION_DATE+9/24,'YYYYMMDDHH24MISS'), ',')
					FROM INFODBA.PEPMTASK A
					     ,INFODBA.PATTACHMENTS B
					     ,INFODBA.PATTACHMENTS B1
					     ,INFODBA.PSIGNOFF C
					     ,INFODBA.PEPMTASK D
					     ,INFODBA.PEPMTASK R
					     ,INFODBA.PPOM_MEMBER M
					     ,INFODBA.PGROUPMEMBER GM
					     ,INFODBA.PUSER F
					     ,INFODBA.PPERSON G
					     ,INFODBA.PPOM_USER H
					     ,INFODBA.PEPMTASKTEMPLATE ET
					     ,INFODBA.PEPMTASKTEMPLATE ET1
					     ,INFODBA.PPOM_APPLICATION_OBJECT PAO
					     ,INFODBA.PWORKSPACEOBJECT WO
					     ,INFODBA.PITEMREVISION REV
					     ,INFODBA.PITEM I
					     ,INFODBA.PWORKSPACEOBJECT SWO
					WHERE A.PUID = B.PUID
					   AND C.PUID = B.PVALU_0
					   AND A.RTASK_TEMPLATEU = ET.PUID
					   AND ET.PTEMPLATE_NAME = 'select-signoff-team'
					   AND R.PUID = B1.PUID
					   AND D.PUID = A.RPARENT_TASKU
					   AND R.PUID = D.RPARENT_TASKU
					   AND M.PUID = GM.PUID
					   AND M.PUID = C.RGROUP_MEMBERU
					   AND M.RUSERU = F.PUID
					   AND F.RPERSONU = G.PUID
					   AND H.PUID = F.PUID
					   AND D.RTASK_TEMPLATEU = ET1.PUID
					   AND ET1.PTEMPLATE_NAME LIKE 'Review%'
					   AND B1.PVALU_0 = WO.PUID
					   AND PAO.PUID = B1.PUID
					   AND PAO.PCREATION_DATE =
					       (SELECT MAX(PCREATION_DATE)
					       FROM INFODBA.PATTACHMENTS A
					            ,INFODBA.PPOM_APPLICATION_OBJECT B
					       WHERE A.PUID = B.PUID
					          AND A.PVALU_0 = REV.PUID
					       )
					   AND WO.POBJECT_TYPE = 'S7_ECIRevision'
					   AND WO.PUID = REV.PUID
					   AND REV.RITEMS_TAGU = I.PUID
					   AND WO.PACTIVE_SEQ = '1'
					   AND REV.PITEM_REVISION_ID =
					       (SELECT MAX(RRR.PITEM_REVISION_ID)
					       FROM INFODBA.PITEMREVISION RRR
					       WHERE RRR.RITEMS_TAGU = I.PUID
					       )
					   AND SWO.PUID = R.PUID
					   AND SWO.PACTIVE_SEQ = '1'
					   AND I.PUID = #{itemPuid} )
			FROM INFODBA.PITEM I
			     ,INFODBA.PITEMREVISION R
			     ,INFODBA.PWORKSPACEOBJECT W
			     ,INFODBA.PS7_ECIREVISION_0 ECI
			     ,INFODBA.PPOM_APPLICATION_OBJECT A
                 ,INFODBA.PPOM_USER U
                 ,INFODBA.PATTACHMENTS T
                 ,INFODBA.PPOM_APPLICATION_OBJECT TA
			WHERE I.PUID = R.RITEMS_TAGU
			   AND R.PUID = W.PUID
			   AND W.PACTIVE_SEQ = 1
			   AND ECI.PUID = W.PUID
			   AND A.PUID = ECI.PUID
         	   AND A.ROWNING_USERU = U.PUID
               AND T.PVALU_0 = ECI.PUID
               AND T.PUID = TA.PUID
			   AND I.PUID = #{itemPuid}
   </insert>
   <update id="updateFileName">
   		UPDATE IF_ECI_INFO_TO_VNET SET REF_FILE = VNET_REGISTERED_ID||REF_FILE  WHERE PLM_ITEM_PUID = #{itemPuid}
   </update>
   <!-- ECI 검토결과를 I/F 테이블에서 가져오기 -->
   <select id="getECIReviewInfo" resultType="com.ssangyong.dto.VnetTeamReviewData">
   		SELECT B.PLM_ITEM_PUID, A.*
		FROM IF_ECI_REVIEW_FROM_VNET A
			,IF_ECI_INFO_TO_VNET B
		WHERE A.VNET_REGISTERED_ID = B.VNET_REGISTERED_ID
		AND B.PLM_ITEM_PUID = #{itemPuid}
   </select>
   <!-- ECI I/F 테이블 업데이트 수신확인 업데이트 -->
   <update id="confirmECIReceived">
   	   UPDATE IF_ECI_INFO_FROM_VNET 
	       SET NPLM_RECEIVED = 'Y'
	     ,NPLM_RECEIVED_DATE = SYSDATE 
	   WHERE VNET_REGISTERED_ID = #{vnetId}
	   AND IF_COUNT = #{ifCount}
   </update>
   <!-- IF_ECI_REVIEW_FROM_VNET 테이블 수신확인 업데이트 -->
   <update id="confirmECIReviewReceived">
	   UPDATE IF_ECI_REVIEW_FROM_VNET 
	       SET NPLM_RECEIVED = 'Y'
	     ,NPLM_RECEIVED_DATE = SYSDATE 
	   WHERE NPLM_RECEIVED = 'N'
   </update>
   <!-- ITEM ID 변경 -->
   <update id="changeItemId">
	   UPDATE INFODBA.PITEM
	   SET PITEM_ID = #{itemId}
	   WHERE PUID = #{itemPuid}
   </update>
   <!-- SQL로 팀센터 Object를 업데이트 후 세션 로그아웃 없이 refresh 할 경우 -->
   <update id="refreshTCObject">
	   UPDATE INFODBA.PPOM_OBJECT
	   SET PTIMESTAMP = DECODE(SUBSTR(PTIMESTAMP,LENGTH(PTIMESTAMP)),'X',SUBSTR(PTIMESTAMP,1,LENGTH(PTIMESTAMP)-1)||'Z', SUBSTR(PTIMESTAMP,1,LENGTH(PTIMESTAMP)-1)||'X')
	   WHERE PUID = #{itemPuid}
   </update>
   <update id="refreshTCTimeStamp">
		MERGE INTO INFODBA.POM_TIMESTAMP A
		USING (SELECT PUID TID, PTIMESTAMP, PLSD FROM INFODBA.PPOM_OBJECT WHERE PUID = #{itemPuid}) B
		ON (A.PUID = B.TID)
		WHEN MATCHED THEN
		UPDATE
		SET A.PTIMESTAMP = DECODE(SUBSTR(A.PTIMESTAMP,LENGTH(A.PTIMESTAMP)),'X',SUBSTR(A.PTIMESTAMP,1,LENGTH(A.PTIMESTAMP)-1)||'Z', SUBSTR(A.PTIMESTAMP,1,LENGTH(A.PTIMESTAMP)-1)||'X')
		WHEN NOT MATCHED THEN
		INSERT (PUID, PTIMESTAMP, PDBTIMESTAMP, PDELETED)
		VALUES (B.TID,  B.PTIMESTAMP, B.PLSD, 1)
   </update>
   <!-- SYMC 인트라넷을 통한 메일 발송 -->
   <update id="sendMail" statementType="CALLABLE">
   		{call CALS.MAILSEND@LINK_001_VNET(#{the_sysid},#{the_sabun},#{the_title},#{the_remark},#{the_tsabun})
   </update>
   <!-- SYMC 인트라넷을 통한 메일 발송 (through EAI) -->
   <select id="sendMailEai">
   INSERT INTO IF_USER.IF_EMAIL (SEQ_NO, SYSTEM_ID, FROM_USERS, TITLE, REMARK, TO_USERS, CREATE_DATE ) 
        SELECT ( SELECT GET_NEXT_MAIL_SEQ() FROM DUAL ) AS SEQ_NO
             , #{the_sysid,jdbcType=VARCHAR,mode=IN}, #{the_sabun,jdbcType=VARCHAR,mode=IN}
             , #{the_title,jdbcType=VARCHAR,mode=IN}
             , #{the_remark,jdbcType=VARCHAR,mode=IN}
             , #{the_tsabun,jdbcType=VARCHAR,mode=IN}
             , SYSDATE
          FROM DUAL
   </select>
   <!-- ECO 승인 시 승인 정보 IF : VPM에서와 같이 바로 ECI 테이블을 업데이트 함 -->
   <update id="interfaceECONoToVnet">
	   	UPDATE CALS.PISA01TB@LINK_001_VNET EV SET ECONO = DECODE(ECONO, NULL, #{ecoNo}, ECONO||','||#{ecoNo})
		WHERE NO IN (
		  SELECT EF.VNET_REGISTERED_ID
		  FROM INFODBA.PITEM I
		          ,INFODBA.PITEMREVISION R
		          ,INFODBA.PWORKSPACEOBJECT W
		          ,INFODBA.PIMANRELATION REL
		          ,INFODBA.PWORKSPACEOBJECT EW
		          ,INFODBA.PITEMREVISION ER
		          ,IF_ECI_INFO_TO_VNET EF
		  WHERE I.PUID = R.RITEMS_TAGU
		    AND R.PUID = W.PUID
		    AND W.PACTIVE_SEQ = '1'
		    AND W.PUID = REL.RPRIMARY_OBJECTU
		    AND REL.RSECONDARY_OBJECTU = EW.PUID
		    AND EW.POBJECT_TYPE = 'S7_ECIRevision'
		    AND EW.PACTIVE_SEQ = '1'
		    AND EW.PDATE_RELEASED IS NOT NULL -- 승인된 ECI
		    AND EW.PUID = ER.PUID
		    AND ER.RITEMS_TAGU = EF.PLM_ITEM_PUID
		    AND I.PITEM_ID = #{ecoNo} )
		 AND NVL(INSTR(ECONO, #{ecoNo}),0) = 0 -- 중복 입력 방지
   </update>
   <update id="updateECIRevisionWithInterface">
	   	UPDATE INFODBA.PS7_ECIREVISION_0 ER
		SET ER.PS7_ST_DATE = SYSDATE-9/24
		<if test="vnetUrl != null">
    		,ER.PS7_VISIONNET_URL = #{vnetUrl}
  		</if>
		<if test="ifStage != null">
    		,ER.PS7_ECI_MATURITY = #{ifStage}
  		</if>
		<if test="approvalNo != null">
    		,ER.PS7_APPROVAL_NO = #{approvalNo}
  		</if>
		<if test="ecoNo != null">
    		,ER.PS7_ECO_NO = #{ecoNo}
  		</if>
		WHERE ER.PUID = (
		  SELECT R.PUID
		  FROM INFODBA.PITEMREVISION R
		      ,INFODBA.PWORKSPACEOBJECT W
		      ,INFODBA.PS7_ECIREVISION_0 ER
		  WHERE ER.PUID = W.PUID
		    AND W.PACTIVE_SEQ = '1'
		    AND R.PUID = ER.PUID
		    AND R.RITEMS_TAGU = #{itemPuid} )
   </update>
   <select id="searchECR" resultType="java.util.HashMap">
	   SELECT TO_CHAR(A.NO) SEQNO
			, A.DOCUNO DOCNO
		    , A.TITLE
		    , A.TEAM CTEAM
		    , U.HNAME CUSER
		    , TO_CHAR(A.TDATE, 'YYYY-MM-DD') CDATE
		FROM  CALS.PISA01TB@LINK_001_VNET A
		     ,CALS.SYSA02TB@LINK_001_VNET U
		WHERE A.CLS1 = '4'
		AND A.SABUN = U.EMPNO
		AND TO_CHAR(A.TDATE, 'YYYY-MM-DD') BETWEEN #{cdateFrom} AND #{cdateTo}
		<if test="docno != null">
    		AND UPPER(A.DOCUNO) LIKE #{docNo}
  		</if>
  		<if test="title != null">
    		AND UPPER(A.TITLE) LIKE #{title}
  		</if>
  		<if test="cteam != null">
    		AND UPPER(A.TEAM) LIKE #{cteam}
  		</if>
  		 <if test="cuser != null">
    		AND UPPER(U.HNAME) LIKE #{cuser}
  		</if>
   </select>
   <update id="changeECIStatus">
	   	UPDATE INFODBA.PS7_ECIREVISION_0 ER
		SET ER.PS7_ECI_MATURITY = #{status}
		WHERE ER.PUID = (
		  SELECT R.PUID
		  FROM INFODBA.PITEMREVISION R
		      ,INFODBA.PWORKSPACEOBJECT W
		      ,INFODBA.PS7_ECIREVISION_0 ER
		  WHERE ER.PUID = W.PUID
		    AND W.PACTIVE_SEQ = '1'
		    AND R.PUID = ER.PUID
		    AND R.RITEMS_TAGU = #{itemPuid} )
   </update>
   <update id="changeECOStatus">
	   	UPDATE INFODBA.PS7_ECOREVISION_0 ER
		SET ER.PS7_ECO_MATURITY = #{ecoStatus}
		WHERE ER.PUID = (
		  SELECT R.PUID
		  FROM INFODBA.PITEMREVISION R
		      ,INFODBA.PWORKSPACEOBJECT W
		      ,INFODBA.PS7_ECOREVISION_0 ER
		  WHERE ER.PUID = W.PUID
		    AND W.PACTIVE_SEQ = '1'
		    AND R.PUID = ER.PUID
		    AND R.PUID = #{ecoRevPuid} )
   </update>
   <select id="getSolutionItems" resultType="java.lang.String">
		SELECT R.PUID 
		FROM ECO_BOM_LIST B
		        ,INFODBA.PITEM I
		        ,INFODBA.PITEMREVISION R
		        ,INFODBA.PWORKSPACEOBJECT W
		WHERE B.NEW_PART_NO = I.PITEM_ID
		  AND I.PUID = R.RITEMS_TAGU
		  AND R.PITEM_REVISION_ID = B.NEW_PART_REV
		  AND R.PUID = W.PUID
		  AND W.PACTIVE_SEQ = '1'
		  AND NOT EXISTS ( 
  				SELECT 1 FROM INFODBA.PRELEASE_STATUS_LIST RSL
					          ,INFODBA.PRELEASESTATUS RS
					          WHERE RSL.PUID = R.PUID
					          AND RSL.PVALU_0 = RS.PUID
					          AND RS.PNAME IN ('S7_Released') )
		  AND ECO_NO = #{ecoNo}
		GROUP BY R.PUID
   </select>
   <select id="getProblemItems" resultType="java.lang.String">
		SELECT R.PUID 
		FROM ECO_BOM_LIST B
		        ,INFODBA.PITEM I
		        ,INFODBA.PITEMREVISION R
		        ,INFODBA.PWORKSPACEOBJECT W
		WHERE B.OLD_PART_NO = I.PITEM_ID
		  AND I.PUID = R.RITEMS_TAGU
		  AND R.PITEM_REVISION_ID = B.OLD_PART_REV
		  AND R.PUID = W.PUID
		  AND W.PACTIVE_SEQ = '1'
		  AND EXISTS ( 
  				SELECT 1 FROM INFODBA.PRELEASE_STATUS_LIST RSL
					          ,INFODBA.PRELEASESTATUS RS
					          WHERE RSL.PUID = R.PUID
					          AND RSL.PVALU_0 = RS.PUID
					          AND RS.PNAME = 'S7_Released' )
		  AND ECO_NO = #{ecoNo}
		GROUP BY R.PUID
   </select>
   <select id="checkEndtoEnd" resultType="java.lang.String">
		SELECT B.NEW_PART_NO||'[S/MODE:'||B.NEW_SMODE||'] 상위 - '||PB.PARENT_NO||'-'||PB.NEW_PART_NO||'[S/MODE:'||PB.NEW_SMODE||']' 
		FROM ECO_BOM_LIST B 
		     ,ECO_BOM_LIST PB 
		WHERE B.NEW_SMODE IN
		       (SELECT V.PVAL_0 
		       FROM INFODBA.PLISTOFVALUES L 
		            ,INFODBA.PLOV_VALUES_3 V 
		            ,INFODBA.PLOV_VALUE_DESCRIPTIONS_3 D 
		       WHERE L.PUID= V.PUID 
		          AND L.PUID =D.PUID 
		          AND V.PSEQ = D.PSEQ 
		          AND L.PLOV_NAME = 'S7_SUPPLY_MODE' 
		          AND SUBSTR( D.PVAL_0,1,1 )  = 'X' 
		       ) 
		   AND B.PARENT_NO = PB.NEW_PART_NO(+) 
		   AND PB.NEW_SMODE IN
		       (SELECT V.PVAL_0 
		       FROM INFODBA.PLISTOFVALUES L 
		            ,INFODBA.PLOV_VALUES_3 V 
		            ,INFODBA.PLOV_VALUE_DESCRIPTIONS_3 D 
		       WHERE L.PUID= V.PUID 
		          AND L.PUID =D.PUID 
		          AND V.PSEQ = D.PSEQ 
		          AND L.PLOV_NAME = 'S7_SUPPLY_MODE' 
		          AND SUBSTR( D.PVAL_0,1,1 )  = 'X'  
		       ) 
		   AND B.ECO_NO = #{ecoNo} 
		      UNION ALL 
		SELECT B.PARENT_NO||'[S/MODE:'||B.NEW_SMODE||'] 하위 - '||PC.NEW_PART_NO||'[S/MODE:'||PC.NEW_SMODE||']' 
		FROM ECO_BOM_LIST B 
		     ,ECO_BOM_LIST PC 
		WHERE B.NEW_SMODE IN
		       (SELECT V.PVAL_0 
		       FROM INFODBA.PLISTOFVALUES L 
		            ,INFODBA.PLOV_VALUES_3 V 
		            ,INFODBA.PLOV_VALUE_DESCRIPTIONS_3 D 
		       WHERE L.PUID= V.PUID 
		          AND L.PUID =D.PUID 
		          AND V.PSEQ = D.PSEQ 
		          AND L.PLOV_NAME = 'S7_SUPPLY_MODE' 
		          AND SUBSTR( D.PVAL_0,1,1 )  = 'X'  
		       ) 
		   AND B.NEW_PART_NO = PC.PARENT_NO(+) 
		   AND PC.NEW_SMODE IN
		       (SELECT V.PVAL_0 
		       FROM INFODBA.PLISTOFVALUES L 
		            ,INFODBA.PLOV_VALUES_3 V 
		            ,INFODBA.PLOV_VALUE_DESCRIPTIONS_3 D 
		       WHERE L.PUID= V.PUID 
		          AND L.PUID =D.PUID 
		          AND V.PSEQ = D.PSEQ 
		          AND L.PLOV_NAME = 'S7_SUPPLY_MODE' 
		          AND SUBSTR( D.PVAL_0,1,1 )  = 'X' 
		       ) 
		   AND B.ECO_NO = #{ecoNo}
   </select>
   
   <!-- 2016-05-30 taeku.jeong ECO_BOM_LIST.PARENT_PROJECT -> ECO_BOM_LIST.NEW_PROJECT 로 수정 -->
	<!-- [20240228] Oracle Version upgrade 로 인한 WM_CONCAT 을 LISTAGG 로 변경 -->
   <select id="getAffectedProject" resultType="java.lang.String">
		SELECT LISTAGG(DISTINCT(NEW_PROJECT), ',') 
		FROM ECO_BOM_LIST 
		WHERE ECO_NO = #{ecoNo}
		AND   EPL_YN = 'Y'
   </select>
   <update id="makePartHistory" parameterType="java.lang.String" statementType="CALLABLE">
	    {call PRC_PART_HISTORY(#{ecoNo, jdbcType=VARCHAR})}
   </update>	
   <select id="checkECOEPL" resultType="java.util.HashMap">
	   WITH REFECO AS (
		    SELECT PR.PUID
		        ,PR.RS7_ECO_NOU
		    FROM INFODBA.PITEMREVISION R
		        ,INFODBA.PITEM I
		        ,INFODBA.PWORKSPACEOBJECT W
		        ,INFODBA.PITEMREVISION PR
		        ,INFODBA.PWORKSPACEOBJECT PW
		    WHERE PR.PUID = PW.PUID
		    AND PW.PACTIVE_SEQ = 1
		    AND W.PACTIVE_SEQ = 1
		    AND W.PUID = R.PUID
		    AND R.PUID = PR.RS7_ECO_NOU
		    AND I.PUID = R.RITEMS_TAGU
		    AND I.PITEM_ID = #{ecoNo} )
		, MISS_ECO AS ( -- ECO 누락
		    SELECT B.EPL_ID
		    FROM ECO_BOM_LIST B
		        ,INFODBA.PITEM I
		        ,INFODBA.PITEMREVISION R
		        ,INFODBA.PWORKSPACEOBJECT W
		    WHERE B.NEW_PART_NO = I.PITEM_ID
		      AND B.NEW_PART_TYPE IN ('S7_Vehpart','S7_FunctionMast')
		      AND I.PUID = R.RITEMS_TAGU
		      AND R.PITEM_REVISION_ID = B.NEW_PART_REV
		      AND R.PUID = W.PUID
		      AND NOT EXISTS (
		          SELECT 1
		          FROM REFECO
		          WHERE REFECO.PUID = R.PUID )
		      AND W.PACTIVE_SEQ = '1'
		      AND NOT EXISTS (
		          SELECT 1
		          FROM INFODBA.PRELEASE_STATUS_LIST RSL
		                  ,INFODBA.PRELEASESTATUS RS
		          WHERE RSL.PUID = R.PUID
		             AND RSL.PVALU_0 = RS.PUID
		             AND RS.PNAME IN ('S7_Released') )
		      AND ECO_NO = #{ecoNo} )
		, MISS_SMODE AS ( -- SMODE 누락
			SELECT B.EPL_ID
		    FROM ECO_BOM_LIST B
		    WHERE B.ECO_NO = #{ecoNo}
		      AND B.NEW_SMODE IS NULL -- S/MODE 필수 체크
		      AND B.NEW_PART_TYPE IN ('S7_Vehpart','S7_Standard') )
		, MISS_OLDIC AS ( -- OLDIC 누락
			SELECT B.EPL_ID
		    FROM ECO_BOM_LIST B
		    WHERE B.ECO_NO = #{ecoNo}
		    AND B.PARENT_TYPE NOT IN ('S7_Function')
		    AND B.OLD_PART_NO IS NOT NULL
		    AND B.NEW_PART_NO IS NOT NULL
		    AND B.OLD_IC IS NULL )
		, MISS_NEWIC AS ( -- NEWIC 누락
			SELECT B.EPL_ID
		    FROM ECO_BOM_LIST B
		    WHERE B.ECO_NO = #{ecoNo}
		    AND B.PARENT_TYPE NOT IN ('S7_Function')
		    AND B.OLD_PART_NO IS NOT NULL
		    AND B.NEW_PART_NO IS NOT NULL
		    AND B.NEW_IC IS NULL )
		, MISS_PSTOCK AS ( -- PLT_STOCK 누락
			SELECT B.EPL_ID
		    FROM ECO_BOM_LIST B
		    WHERE B.ECO_NO = #{ecoNo}
		    AND B.PARENT_TYPE NOT IN ('S7_Function')
		    AND B.OLD_PART_NO IS NOT NULL
		    AND B.OLD_PLT_STK IS NULL )
		, MISS_ASTOCK AS ( -- AS_STOCK 누락
			SELECT B.EPL_ID
		    FROM ECO_BOM_LIST B
		    WHERE B.ECO_NO = #{ecoNo}
		    AND B.PARENT_TYPE NOT IN ('S7_Function')
		    AND B.OLD_PART_NO IS NOT NULL
		    AND B.OLD_AS_STK IS NULL )
		,UNIALL AS (
			SELECT EPL_ID, 'ECO No 누락' T FROM MISS_ECO UNION ALL
		    SELECT EPL_ID, 'S/MODE 누락' T FROM MISS_SMODE UNION ALL
		    SELECT EPL_ID, 'old IC 누락' T FROM MISS_OLDIC UNION ALL
		    SELECT EPL_ID, 'new IC 누락' T FROM MISS_NEWIC UNION ALL
		    SELECT EPL_ID, 'PLT  Stock 누락' T FROM MISS_PSTOCK UNION ALL
		    SELECT EPL_ID, 'AS Stock 누락' T FROM MISS_ASTOCK )
		SELECT B.EPL_ID
			     ,B.ECO_NO
			     ,B.OCC_THREADS
			     ,B.PARENT_NO
			     ,B.PARENT_REV
			     ,B.NEW_PART_NO
			     ,B.NEW_PART_REV
			     ,B.NEW_SEQ
			     ,TO_CHAR(B.NEW_QTY) NEW_QTY
			     ,MAX(DECODE(A.T, 'S/MODE 누락', A.T)) NEW_SMODE
		         ,MAX(DECODE(A.T, 'ECO No 누락', A.T)) REF_ECO
		         ,MAX(DECODE(A.T, 'old IC 누락', A.T)) OLD_IC
		         ,MAX(DECODE(A.T, 'new IC 누락', A.T)) NEW_IC
		         ,MAX(DECODE(A.T, 'PLT  Stock 누락', A.T)) PLT_ST
		         ,MAX(DECODE(A.T, 'AS Stock 누락', A.T)) AS_ST
		FROM ECO_BOM_LIST B
			,UNIALL A
		WHERE B.ECO_NO = #{ecoNo}
		AND B.EPL_ID = A.EPL_ID
		GROUP BY B.EPL_ID
			     ,B.ECO_NO
			     ,B.OCC_THREADS
			     ,B.PARENT_NO
			     ,B.PARENT_REV
			     ,B.NEW_PART_NO
			     ,B.NEW_PART_REV
			     ,B.NEW_SEQ
		         ,TO_CHAR(B.NEW_QTY)
   </select>
   <update id="updateEcoStatus" statementType="CALLABLE">
   		{call update_eco_status(#{ecoRevPuid},#{ecoStatus},#{itemStatus})}
   </update>
	<!-- [20240228] Oracle Version upgrade 로 인한 WM_CONCAT 을 LISTAGG 로 변경 -->
   <select id="getEcoInfo" resultType="com.ssangyong.dto.TCEcoModel">
	   WITH ECI AS (                                                                                                                                                                     
	            SELECT IR.RPRIMARY_OBJECTU PUID, LISTAGG(AI.PITEM_ID, ',') PITEM_ID, LISTAGG(TO_CHAR(AW.PDATE_RELEASED+9/24, 'YYYY-MM-DD'), ',') RELEASED_DATE, LISTAGG(AG.PNAME, ',') PNAME   
	            FROM INFODBA.PITEM AI                                                                                                                                                 
	                ,INFODBA.PITEMREVISION AR                                                                                                                                         
	                ,INFODBA.PS7_ECIREVISION_0 AV                                                                                                                                       
	                ,INFODBA.PWORKSPACEOBJECT AW                                                                                                                                      
	            ,INFODBA.PPOM_APPLICATION_OBJECT AP                                                                                                                                   
	            ,INFODBA.PPOM_GROUP AG                                                                                                                                                
	                ,INFODBA.PIMANRELATION IR                                                                                                                                         
	            WHERE AI.PUID = AR.RITEMS_TAGU                                                                                                                                        
	            AND AR.PUID = AV.PUID                                                                                                                                                 
	            AND AR.PUID = AW.PUID                                                                                                                                                 
	            AND AR.PUID = IR.RSECONDARY_OBJECTU                                                                                                                                   
	            AND IR.RPRIMARY_OBJECTU IS NOT NULL                                                                                                                                   
	            AND AW.PACTIVE_SEQ = '1'                                                                                                                                              
	        AND AW.PUID = AP.PUID                                                                                                                                                     
	        AND AP.ROWNING_GROUPU = AG.PUID                                                                                                                                           
	        GROUP BY IR.RPRIMARY_OBJECTU  )                                                                                                                                           
		, ECO AS (                                                                                                                                                                        
	            SELECT IR.RPRIMARY_OBJECTU PUID, LISTAGG(AI.PITEM_ID, ',') PITEM_ID                                                                                                      
	            FROM INFODBA.PITEM AI                                                                                                                                                 
	                ,INFODBA.PITEMREVISION AR                                                                                                                                         
	                ,INFODBA.PS7_ECOREVISION_0 AV                                                                                                                                       
	                ,INFODBA.PWORKSPACEOBJECT AW                                                                                                                                      
	                ,INFODBA.PIMANRELATION IR                                                                                                                                         
	            WHERE AI.PUID = AR.RITEMS_TAGU                                                                                                                                        
	            AND AR.PUID = AV.PUID                                                                                                                                                 
	            AND AR.PUID = AW.PUID                                                                                                                                                 
	            AND AR.PUID = IR.RSECONDARY_OBJECTU                                                                                                                                   
	            AND IR.RPRIMARY_OBJECTU IS NOT NULL                                                                                                                                   
	            AND AW.PACTIVE_SEQ = '1'                                                                                                                                              
	        GROUP BY IR.RPRIMARY_OBJECTU )                                                                                                                                            
		, WF AS (                                                                                                                                                                         
	            SELECT PUID                                                                                                                                                           
	                  ,TO_CHAR(CDATE, 'YYYY-MM-DD') INWORK                                                                                                                            
	                  ,MAX(DECODE(TN||GN, 'Related Team Review'||#{rndManagement}, GN)) INREVIEW1TEAM                                                                             
	                  ,MAX(DECODE(TN||GN, 'Related Team Review'||#{rndManagement}, UN)) INREVIEW1USER                                                                             
	                  ,MAX(DECODE(TN||GN, 'Related Team Review'||#{rndManagement}, TEL)) INREVIEW1TEL                                                                             
	                  ,TO_CHAR(MAX(DECODE(TN||GN, 'Related Team Review'||#{rndManagement}, DCDATE)), 'YYYY-MM-DD') INREVIEW1                                                      
	                  ,MAX(DECODE(TN||GN, 'Related Team ReviewVEHICLE CERTIFICATION', GN)) INREVIEW2TEAM                                                                                             
	                  ,MAX(DECODE(TN||GN, 'Related Team ReviewVEHICLE CERTIFICATION', UN)) INREVIEW2USER                                                                                             
	                  ,MAX(DECODE(TN||GN, 'Related Team ReviewVEHICLE CERTIFICATION', TEL)) INREVIEW2TEL                                                                                             
	                  ,TO_CHAR(MAX(DECODE(TN||GN, 'Related Team ReviewVEHICLE CERTIFICATION', DCDATE)), 'YYYY-MM-DD') INREVIEW2                                                                      
	                  ,MAX(DECODE(TN||GN, 'Related Team Review'||#{engineeringCost}, GN)) INREVIEW3TEAM                                                                                      
	                  ,MAX(DECODE(TN||GN, 'Related Team Review'||#{engineeringCost}, UN)) INREVIEW3USER                                                                                      
	                  ,MAX(DECODE(TN||GN, 'Related Team Review'||#{engineeringCost}, TEL)) INREVIEW3TEL                                                                                      
	                  ,TO_CHAR(MAX(DECODE(TN||GN, 'Related Team Review'||#{engineeringCost}, DCDATE)), 'YYYY-MM-DD') INREVIEW3                                                               
	                  ,MAX(DECODE(TN, 'Sub-team Leader', GN)) INAPPROVALTEAM                                                                                                          
	                  ,MAX(DECODE(TN, 'Sub-team Leader', UN)) INAPPROVALUSER                                                                                                          
	                  ,MAX(DECODE(TN, 'Sub-team Leader', TEL)) INAPPROVALTEL                                                                                                          
	                  ,TO_CHAR(MAX(DECODE(TN,'Sub-team Leader', DCDATE)), 'YYYY-MM-DD') INAPPROVAL                                                                                    
	                  ,MAX(DECODE(TN, 'Design Team Leader', GN)) APPROVEDTEAM                                                                                                         
	                  ,MAX(DECODE(TN, 'Design Team Leader', UN)) APPROVEDUSER                                                                                                         
	                  ,MAX(DECODE(TN, 'Design Team Leader', TEL)) APPROVEDTEL                                                                                                         
	                  ,TO_CHAR(MAX(DECODE(TN,'Design Team Leader', DCDATE)), 'YYYY-MM-DD')  APPROVED                                                                                  
	                  ,MAX(DECODE(TN, 'Technical Management', GN)) COMPLETEDTEAM                                                                                                      
	                  ,MAX(DECODE(TN, 'Technical Management', UN)) COMPLETEDUSER                                                                                                      
	                  ,MAX(DECODE(TN, 'Technical Management', TEL)) COMPLETEDTEL                                                                                                      
	                  ,TO_CHAR(MAX(DECODE(TN,'Technical Management', DCDATE)), 'YYYY-MM-DD') COMPLETED                                                                                
	            FROM (                                                                                                                                                                
	              SELECT WO.PUID                                                                                                                                                      
	                   , ET1.PTEMPLATE_NAME TN                                                                                                                                        
	                   , H.PUSER_NAME UN                                                                                                                                              
	                   , P.PPA10 TEL                                                                                                                                                  
	                   , G.PNAME GN                                                                                                                                                   
	                   , WAO.PCREATION_DATE+9/24 WCDATE                                                                                                                               
	                   , PAO.PCREATION_DATE+9/24 CDATE                                                                                                                                
	                   , C.PDECISION_DATE+9/24 DCDATE                                                                                                                                 
	              FROM INFODBA.PEPMTASK A                                                                                                                                             
	                  ,INFODBA.PATTACHMENTS B                                                                                                                                         
	                  ,INFODBA.PATTACHMENTS B1                                                                                                                                        
	                  ,INFODBA.PSIGNOFF C                                                                                                                                             
	                  ,INFODBA.PEPMTASK D                                                                                                                                             
	                  ,INFODBA.PEPMTASK R                                                                                                                                             
	                  ,INFODBA.PPOM_MEMBER M                                                                                                                                          
	                  ,INFODBA.PPOM_GROUP G                                                                                                                                           
	                  ,INFODBA.PPOM_USER H                                                                                                                                            
	                  ,INFODBA.PUSER U                                                                                                                                                
	                  ,INFODBA.PPERSON P                                                                                                                                              
	                  ,INFODBA.PEPMTASKTEMPLATE ET                                                                                                                                    
	                  ,INFODBA.PEPMTASKTEMPLATE ET1                                                                                                                                   
	                  ,INFODBA.PPOM_APPLICATION_OBJECT PAO                                                                                                                            
	                  ,INFODBA.PWORKSPACEOBJECT WO                                                                                                                                    
	                  ,INFODBA.PPOM_APPLICATION_OBJECT WAO                                                                                                                            
	              WHERE A.PUID = B.PUID                                                                                                                                               
	              AND C.PUID = B.PVALU_0                                                                                                                                              
	            AND A.RTASK_TEMPLATEU = ET.PUID                                                                                                                                       
	            AND ET.PTEMPLATE_NAME = 'select-signoff-team'                                                                                                                         
	            AND R.PUID = B1.PUID                                                                                                                                                  
	            AND D.PUID = A.RPARENT_TASKU                                                                                                                                          
	            AND R.PUID = D.RPARENT_TASKU                                                                                                                                          
	            AND M.PUID = C.RGROUP_MEMBERU                                                                                                                                         
	            AND M.RUSERU = H.PUID                                                                                                                                                 
	            AND H.PUID = U.PUID                                                                                                                                                   
	            AND U.RPERSONU = P.PUID                                                                                                                                               
	            AND M.RGROUPU = G.PUID                                                                                                                                                
	            AND D.RTASK_TEMPLATEU = ET1.PUID                                                                                                                                      
	            AND ET1.PTEMPLATE_NAME IN ('Related Team Review', 'Sub-team Leader', 'Design Team Leader', 'Technical Management')                                                    
	            AND B1.PVALU_0 = WO.PUID                                                                                                                                              
	            AND PAO.PUID = B1.PUID                                                                                                                                                
	            AND PAO.PCREATION_DATE =                                                                                                                                              
	               (SELECT MAX(PCREATION_DATE)                                                                                                                                        
	               FROM INFODBA.PATTACHMENTS A                                                                                                                                        
	                ,INFODBA.PPOM_APPLICATION_OBJECT B                                                                                                                                
	               WHERE A.PUID = B.PUID                                                                                                                                              
	                  AND A.PVALU_0 = WO.PUID                                                                                                                                         
	               )                                                                                                                                                                  
	            AND WO.POBJECT_TYPE = 'S7_ECORevision'                                                                                                                                
	            AND WO.PACTIVE_SEQ = '1'                                                                                                                                              
	            AND WO.PUID = WAO.PUID                                                                                                                                                
	            ) WF                                                                                                                                                                  
	            GROUP BY PUID, WCDATE, CDATE )                                                                                                                                        
		SELECT                                                                                                                                                                            
		    ROW_NUMBER() OVER (ORDER BY A.PCREATION_DATE)  seq                                                                                                                            
		    ,E.PS7_PLANT_CODE plantCode                                                                                                                                                   
		    ,I.PITEM_ID ecoNo                                                                                                                                                             
		    ,(  SELECT D.PVAL_0                                                                                                                                                           
		        FROM                                                                                                                                                                      
		          INFODBA.PLISTOFVALUES L                                                                                                                                                 
		         ,INFODBA.PLOV_VALUES_3 V                                                                                                                                                 
		         ,INFODBA.PLOV_VALUE_DESCRIPTIONS_3 D                                                                                                                                     
		        WHERE L.PUID = V.PUID                                                                                                                                                     
		         AND V.PUID = D.PUID                                                                                                                                                      
		         AND V.PSEQ = D.PSEQ                                                                                                                                                      
		         AND L.PLOV_NAME = 'S7_ECO_REASON'                                                                                                                                        
		         AND V.PVAL_0 = E.PS7_CHANGE_REASON ) changeReason                                                                                                                        
		    ,G.PNAME owningTeam                                                                                                                                                           
		    ,P.PUSER_NAME owningUser                                                                                                                                                      
		    ,P.PPA10 ownerTel                                                                                                                                                             
		    ,DECODE(E.PS7_ECO_MATURITY, NULL, 'In Work', E.PS7_ECO_MATURITY) ecoStatus                                                                                                   
		    ,TO_CHAR(W.PDATE_RELEASED, 'YYYY-MM-DD HH24:MI:SS') releaseDate                                                                                                               
		    ,E.PS7_ECR_NO ecrNo                                                                                                                                                           
		    ,'' ecrDate                                                                                                                                                                   
		    ,'' ecrDept                                                                                                                                                                   
		    ,ECI.PITEM_ID eciNo                                                                                                                                                           
		    ,ECI.RELEASED_DATE eciReleaseDate                                                                                                                                             
		    ,ECI.PNAME eciDept                                                                                                                                                            
		    ,TO_CHAR(A.PCREATION_DATE, 'YYYY-MM-DD HH24:MI:SS') createDate  
		    ,GET_REG_ECO(E.PUID) regNsafe                                                                                                            
		    ,DECODE(E.PS7_EFFECT_POINT, 'Y', 'ASAP', E.PS7_EFFECT_POINT_DATE) cfgEffectPoint                                                                                              
		    ,ECO.PITEM_ID concurrentImpl                                                                                                                                                  
		    ,W.POBJECT_DESC ecoTitle                                                                                                                                                      
		    ,WF.INWORK requestDate                                                                                                                                                        
		    ,WF.INREVIEW1   techDate                                                                                                                                                      
		    ,WF.INREVIEW1TEAM techTeam                                                                                                                                                    
		    ,WF.INREVIEW1USER techUser                                                                                                                                                    
		    ,WF.INREVIEW1TEL techTel                                                                                                                                                      
		    ,WF.INREVIEW2   purcDate                                                                                                                                                      
		    ,WF.INREVIEW2TEAM purcTeam                                                                                                                                                    
		    ,WF.INREVIEW2USER purcUser                                                                                                                                                    
		    ,WF.INREVIEW2TEL purcTel                                                                                                                                                      
		    ,WF.INREVIEW3   costDate                                                                                                                                                      
		    ,WF.INREVIEW3TEAM costTeam                                                                                                                                                    
		    ,WF.INREVIEW3USER costUser                                                                                                                                                    
		    ,WF.INREVIEW3TEL costTel                                                                                                                                                      
		    ,WF.INAPPROVAL inApprovalDate                                                                                                                                                 
		    ,WF.INAPPROVALTEAM inApprovalTeam                                                                                                                                             
		    ,WF.INAPPROVALUSER inApprovalUser                                                                                                                                             
		    ,WF.INAPPROVALTEL inApprovalTel                                                                                                                                               
		    ,WF.APPROVED approvedDate                                                                                                                                                     
		    ,WF.APPROVEDTEAM approvedTeam                                                                                                                                                 
		    ,WF.APPROVEDUSER approvedUser                                                                                                                                                 
		    ,WF.APPROVEDTEL approvedTel                                                                                                                                                   
		    ,WF.COMPLETED completedDate                                                                                                                                                   
		    ,WF.COMPLETEDTEAM completedTeam                                                                                                                                               
		    ,WF.COMPLETEDUSER completedUser                                                                                                                                               
		    ,WF.COMPLETEDTEL completedTel                                                                                                                                                 
		    ,E.PS7_ECO_TYPE ecotype                                                                                                                                                       
		    ,E.PS7_AFFECTED_PROJECT affectedProj                                                                                                                                          
		FROM INFODBA.PS7_ECOREVISION_0 E                                                                                                                                                    
		    ,INFODBA.PWORKSPACEOBJECT W                                                                                                                                                   
		    ,INFODBA.PPOM_APPLICATION_OBJECT A                                                                                                                                            
		    ,INFODBA.PITEM I                                                                                                                                                              
		    ,INFODBA.PITEMREVISION R                                                                                                                                                      
		    ,INFODBA.PRELEASE_STATUS_LIST RL                                                                                                                                              
		    ,INFODBA.PRELEASESTATUS RS                                                                                                                                                    
		    ,INFODBA.PPOM_GROUP G                                                                                                                                                         
		    ,INFODBA.PPOM_USER O                                                                                                                                                          
		    ,INFODBA.PUSER U                                                                                                                                                              
		    ,INFODBA.PPERSON P                                                                                                                                                            
		    ,ECI                                                                                                                                                                          
		    ,ECO                                                                                                                                                                          
		    ,WF                                                                                                                                                                           
		WHERE E.PUID = W.PUID                                                                                                                                                             
		AND W.PUID = A.PUID                                                                                                                                                               
		AND E.PUID = R.PUID                                                                                                                                                               
		AND R.RITEMS_TAGU = I.PUID                                                                                                                                                        
		AND W.PACTIVE_SEQ = 1                                                                                                                                                             
		AND R.PUID = RL.PUID(+)                                                                                                                                                           
		AND RL.PVALU_0 = RS.PUID(+)                                                                                                                                                       
		AND A.ROWNING_GROUPU = G.PUID                                                                                                                                                     
		AND A.ROWNING_USERU = O.PUID                                                                                                                                                      
		AND O.PUID = U.PUID                                                                                                                                                               
		AND U.RPERSONU = P.PUID                                                                                                                                                           
		AND R.PUID = ECI.PUID(+)                                                                                                                                                          
		AND R.PUID = ECO.PUID(+)                                                                                                                                                          
		AND R.PUID = WF.PUID(+)                                                                                                                                                           
		AND I.PITEM_ID = UPPER(#{ecoNo})
   </select>
   <select id="getEcoWorkflowInfo" resultType="java.util.HashMap">
		SELECT NVL(ET1.PTEMPLATE_NAME, ' ') TN
		     , NVL(H.PUSER_NAME, ' ') UN
		     , NVL(P.PPA10, ' ') TEL
		     , NVL(TO_CHAR(C.PDECISION_DATE+9/24, 'YYYY-MM-DD'), ' ') DCDATE
		     , NVL(G.PNAME, ' ') GN 
		FROM INFODBA.PEPMTASK A 
		        ,INFODBA.PATTACHMENTS B 
		        ,INFODBA.PATTACHMENTS B1
		        ,INFODBA.PSIGNOFF C 
		        ,INFODBA.PEPMTASK D 
		        ,INFODBA.PEPMTASK R 
		        ,INFODBA.PPOM_MEMBER M
		        ,INFODBA.PPOM_GROUP G 
		        ,INFODBA.PPOM_USER H
		        ,INFODBA.PUSER U
		        ,INFODBA.PPERSON P
		        ,INFODBA.PEPMTASKTEMPLATE ET
		        ,INFODBA.PEPMTASKTEMPLATE ET1 
		        ,INFODBA.PPOM_APPLICATION_OBJECT PAO
		        ,INFODBA.PWORKSPACEOBJECT WO
		        ,INFODBA.PPOM_APPLICATION_OBJECT WAO
		        ,INFODBA.PITEMREVISION ER
		        ,INFODBA.PITEM EI
		WHERE A.PUID = B.PUID 
		AND C.PUID = B.PVALU_0
		AND A.RTASK_TEMPLATEU = ET.PUID 
		AND ET.PTEMPLATE_NAME = 'select-signoff-team' 
		AND R.PUID = B1.PUID
		AND D.PUID = A.RPARENT_TASKU
		AND R.PUID = D.RPARENT_TASKU
		AND M.PUID = C.RGROUP_MEMBERU 
		AND M.RUSERU = H.PUID 
		AND H.PUID = U.PUID 
		AND U.RPERSONU = P.PUID 
		AND M.RGROUPU = G.PUID
		AND D.RTASK_TEMPLATEU = ET1.PUID
		AND ET1.PTEMPLATE_NAME IN ('Related Team Review', 'Sub-team Leader', 'Design Team Leader', 'Technical Management','Reference Department')
		AND B1.PVALU_0 = WO.PUID
		AND PAO.PUID = B1.PUID
		AND PAO.PCREATION_DATE = (
		         SELECT MAX(PCREATION_DATE)
		         FROM INFODBA.PATTACHMENTS A
		        ,INFODBA.PPOM_APPLICATION_OBJECT B
		         WHERE A.PUID = B.PUID
		        AND A.PVALU_0 = WO.PUID )
		AND WO.PACTIVE_SEQ = '1'
		AND WO.PUID = WAO.PUID
		AND WO.PUID = ER.PUID
		AND ER.RITEMS_TAGU = EI.PUID
		AND EI.PITEM_ID = #{ecoNo}
		ORDER BY DECODE(ET1.PTEMPLATE_NAME,'Related Team Review', 1, 'Sub-team Leader', 2, 'Design Team Leader', 3, 'Technical Management', 4, 'Reference Department', 5)
    </select>
   	<select id="childrenCount" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT COUNT(PUID) FROM INFODBA.PPSOCCURRENCE O WHERE O.RPARENT_BVRU = #{bvrPuid}
	</select>
	<select id="workflowCount" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT COUNT(W.PUID) FROM INFODBA.PWORKSPACEOBJECT W WHERE W.POBJECT_TYPE = 'Job' AND W.POBJECT_NAME LIKE '%'||#{ecoNo}||'%'
	</select>
	<select id="getEcoRevisionPuid" parameterType="java.lang.String" resultType="java.lang.String">
	    SELECT EIR.PUID
        FROM INFODBA.PITEM EI
             , INFODBA.PITEMREVISION IR
             , INFODBA.PS7_ECOREVISION_0 EIR
             , INFODBA.PWORKSPACEOBJECT EIRW
        WHERE EI.PITEM_ID = #{ecoNo}
           AND EI.PUID = IR.RITEMS_TAGU
           AND IR.PUID = EIR.PUID
           AND EIR.PUID = EIRW.PUID
           AND EIRW.PACTIVE_SEQ = 1
	</select>
	
		<!--  
	 * [20230406][CF-3876] 기술관리팀 이보현 책임, 안추은 책임 요청
	 * #1. Vehicle ECO에 파워트레인 프로젝트가 존재 유무 체크 
	 * #2. Vehicle ECO(차량 ECO)의 EPL Proj속성에 파워트레인 프로젝트 존재시 오류 처리 
	 * #3. 파워트레인 프로젝트는 Power Traing ECO(엔진 ECO)로 작업 해야한다.
	 * ECO 결재 요청 시 차량 ECO번호를 채번하고 엔진이나 미션 파트를 추가한 경우 error 가 나옴.
	 */ 
	 -->
   <select id="checkPowerTraing" resultType="java.util.HashMap">
		WITH A AS (
		    SELECT DISTINCT NEW_PROJECT
		    FROM   ECO_BOM_LIST EPL,
		           INFODBA.PITEM I,
		           INFODBA.PITEMREVISION R,
		           INFODBA.PS7_ECOREVISION ECOR,
		           INFODBA.PWORKSPACEOBJECT WSO
		    WHERE  EPL.ECO_NO = I.PITEM_ID
		    AND    I.PUID = R.RITEMS_TAGU
		    AND    R.PUID = ECOR.PUID
		    AND    R.PUID = WSO.PUID
		    AND    ECOR.PS7_ECO_KIND = 'V'
		    AND    ECO_NO = #{ecoNo, jdbcType=VARCHAR}
			), PJTTABLE AS (
			    SELECT DISTINCT TRIM(REGEXP_SUBSTR(NEW_PROJECT, '[^,]+', 1, LEVEL)) PJT
			    FROM   A
			    CONNECT BY REGEXP_SUBSTR(NEW_PROJECT, '[^,]+', 1, LEVEL ) IS NOT NULL
			)
			SELECT DECODE(COUNT(*), 0, 'pass', 'error') CHECK_ENGINE_PART
			FROM   PJTTABLE
			WHERE  PJT IN (
		        SELECT D.PVAL_0 AS ENGINCODE
		        FROM   INFODBA.PLOV_VALUES_3 V, INFODBA.PLOV_VALUE_DESCRIPTIONS_3 D,
		               (SELECT PUID FROM INFODBA.PLISTOFVALUESSTRING WHERE PUID = (SELECT PUID FROM INFODBA.PLISTOFVALUES WHERE PLOV_NAME = 'S7_PRODUCT_CODE')) LOV
		        WHERE  V.PUID = LOV.PUID AND D.PUID = LOV.PUID AND V.PSEQ = D.PSEQ
		        )
   </select>
	
</mapper>